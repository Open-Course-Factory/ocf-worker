#!/bin/bash
set -e

echo "ğŸ§ª Testing Storage API integration with Docker Compose..."

# VÃ©rifier que les services sont en cours d'exÃ©cution
echo "ğŸ” Checking if services are running..."
if ! docker-compose ps | grep -q "ocf-worker.*Up"; then
    echo "âŒ OCF Worker service is not running!"
    echo "ğŸ’¡ Please start with: docker-compose up -d"
    exit 1
fi

if ! docker-compose ps | grep -q "postgres-worker.*Up"; then
    echo "âŒ PostgreSQL service is not running!"
    echo "ğŸ’¡ Please start with: docker-compose up -d"
    exit 1
fi

echo "âœ… Services are running"

# Attendre que le service soit prÃªt
echo "â³ Waiting for OCF Worker to be ready..."
for i in {1..30}; do
    if curl -s http://localhost:8081/health >/dev/null 2>&1; then
        echo "âœ… OCF Worker is ready"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "âŒ OCF Worker failed to start within 30 seconds"
        echo "ğŸ“Š Service logs:"
        docker-compose logs --tail=20 ocf-worker
        exit 1
    fi
    sleep 1
done

# CrÃ©er les rÃ©pertoires et fichiers de test
mkdir -p test-files

# CrÃ©er des fichiers de test
cat > test-files/slides.md << 'MDEOF'
# Test Course

## Slide 1
Hello, World!

## Slide 2
This is a test course.

---

## Slide 3
- Point 1
- Point 2
- Point 3

## Slide 4
```javascript
console.log("Hello from code!");
```
MDEOF

cat > test-files/theme.css << 'CSSEOF'
.slidev-layout {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.slidev-layout h1 {
    color: #ffd700;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

.slidev-layout h2 {
    border-bottom: 2px solid #ffd700;
    padding-bottom: 10px;
}
CSSEOF

cat > test-files/config.json << 'JSONEOF'
{
    "theme": "default",
    "title": "Test Course",
    "author": "OCF Worker Test",
    "description": "Generated by OCF Worker test suite",
    "highlighter": "prism",
    "lineNumbers": true,
    "monaco": true,
    "colorSchema": "dark"
}
JSONEOF

cat > test-files/logo.svg << 'SVGEOF'
<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg">
  <circle cx="50" cy="50" r="40" stroke="black" stroke-width="3" fill="red" />
  <text x="50" y="55" text-anchor="middle" fill="white" font-size="16">OCF</text>
</svg>
SVGEOF

# Fonction pour nettoyer
cleanup() {
    echo "ğŸ§¹ Cleaning up test files..."
    rm -rf test-files
}

trap cleanup EXIT

# Test health check
echo "ğŸ“Š Testing health check..."
HEALTH_RESPONSE=$(curl -s http://localhost:8081/health)
echo "$HEALTH_RESPONSE" | jq .
if echo "$HEALTH_RESPONSE" | jq -e '.status == "healthy"' >/dev/null; then
    echo "âœ… Health check passed"
else
    echo "âŒ Health check failed"
    exit 1
fi

# Test storage info
echo "ğŸ“‹ Testing storage info..."
STORAGE_INFO=$(curl -s http://localhost:8081/api/v1/storage/info)
echo "$STORAGE_INFO" | jq .
echo "âœ… Storage info retrieved"

# GÃ©nÃ©rer des IDs pour les tests
if command -v uuidgen >/dev/null 2>&1; then
    JOB_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
    COURSE_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
else
    # Fallback si uuidgen n'est pas disponible
    JOB_ID="test-job-$(date +%s)"
    COURSE_ID="test-course-$(date +%s)"
fi

echo "ğŸ†” Using Job ID: $JOB_ID"
echo "ğŸ†” Using Course ID: $COURSE_ID"

# Test upload de fichiers sources
echo "ğŸ“¤ Testing multipart file upload..."
UPLOAD_RESPONSE=$(curl -s -X POST \
  -F "files=@test-files/slides.md" \
  -F "files=@test-files/theme.css" \
  -F "files=@test-files/config.json" \
  -F "files=@test-files/logo.svg" \
  http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources)

echo "$UPLOAD_RESPONSE" | jq .

if echo "$UPLOAD_RESPONSE" | jq -e '.count == 4' >/dev/null; then
    echo "âœ… File upload successful (4 files)"
else
    echo "âŒ File upload failed"
    exit 1
fi

# Test listing des fichiers sources
echo "ğŸ“ Testing source files listing..."
LIST_RESPONSE=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources)
echo "$LIST_RESPONSE" | jq .

FILE_COUNT=$(echo "$LIST_RESPONSE" | jq '.files | length')
if [ "$FILE_COUNT" -eq 4 ]; then
    echo "âœ… File listing successful ($FILE_COUNT files found)"
else
    echo "âŒ File listing failed (expected 4 files, got $FILE_COUNT)"
    exit 1
fi

# Test download de chaque fichier source
echo "ğŸ“¥ Testing source file downloads..."

echo "ğŸ“„ Downloading slides.md:"
SLIDES_CONTENT=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/slides.md)
if echo "$SLIDES_CONTENT" | grep -q "# Test Course"; then
    echo "âœ… slides.md download successful"
else
    echo "âŒ slides.md download failed"
    echo "Content: $SLIDES_CONTENT"
    exit 1
fi

echo "ğŸ¨ Downloading theme.css:"
THEME_CONTENT=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/theme.css)
if echo "$THEME_CONTENT" | grep -q "slidev-layout"; then
    echo "âœ… theme.css download successful"
else
    echo "âŒ theme.css download failed"
    exit 1
fi

echo "âš™ï¸ Downloading config.json:"
CONFIG_CONTENT=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/config.json)
if echo "$CONFIG_CONTENT" | jq -e '.title == "Test Course"' >/dev/null 2>&1; then
    echo "âœ… config.json download successful"
else
    echo "âŒ config.json download failed"
    exit 1
fi

echo "ğŸ–¼ï¸ Downloading logo.svg:"
LOGO_CONTENT=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/logo.svg)
if echo "$LOGO_CONTENT" | grep -q "<svg"; then
    echo "âœ… logo.svg download successful"
else
    echo "âŒ logo.svg download failed"
    exit 1
fi

# Test crÃ©ation d'un job via API
echo "ğŸ“‹ Testing job creation..."
JOB_RESPONSE=$(curl -s -X POST http://localhost:8081/api/v1/generate \
  -H "Content-Type: application/json" \
  -d "{
    \"job_id\": \"$JOB_ID\",
    \"course_id\": \"$COURSE_ID\",
    \"source_path\": \"sources/$JOB_ID/\",
    \"callback_url\": \"http://localhost:8080/api/v1/generations/$JOB_ID/status\"
  }")

echo "$JOB_RESPONSE" | jq .

if echo "$JOB_RESPONSE" | jq -e '.status == "pending"' >/dev/null; then
    echo "âœ… Job creation successful"
else
    echo "âŒ Job creation failed"
    exit 1
fi

# Test rÃ©cupÃ©ration du statut du job
echo "ğŸ“ˆ Testing job status retrieval..."
STATUS_RESPONSE=$(curl -s http://localhost:8081/api/v1/jobs/$JOB_ID)
echo "$STATUS_RESPONSE" | jq .

if echo "$STATUS_RESPONSE" | jq -e '.id' >/dev/null; then
    echo "âœ… Job status retrieval successful"
else
    echo "âŒ Job status retrieval failed"
    exit 1
fi

# Test listing de tous les jobs
echo "ğŸ“Š Testing jobs listing..."
JOBS_RESPONSE=$(curl -s http://localhost:8081/api/v1/jobs)
echo "$JOBS_RESPONSE" | jq '.jobs | length'
echo "âœ… Jobs listing successful"

# Test des erreurs - fichier inexistant
echo "ğŸš« Testing error handling..."
ERROR_RESPONSE=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/nonexistent.txt)
if echo "$ERROR_RESPONSE" | grep -q "error"; then
    echo "âœ… Error handling working correctly"
else
    echo "âŒ Error handling failed"
fi

# Test upload avec type de fichier non autorisÃ©
echo "ğŸš« Testing file type validation..."
echo "malicious content" > test-files/malicious.exe
UPLOAD_ERROR=$(curl -s -X POST \
  -F "files=@test-files/malicious.exe" \
  http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources)

if echo "$UPLOAD_ERROR" | grep -q "file type not allowed"; then
    echo "âœ… File type validation working"
else
    echo "âŒ File type validation failed"
    echo "Response: $UPLOAD_ERROR"
fi

rm -f test-files/malicious.exe

# VÃ©rification dans le container
echo "ğŸ³ Checking files in Docker container..."
docker-compose exec ocf-worker ls -la /app/storage/sources/$JOB_ID/ || echo "Storage directory structure may be different"

# Test des logs (mÃªme s'ils sont vides pour l'instant)
echo "ğŸ“ Testing logs retrieval..."
LOGS_RESPONSE=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/logs)
# Les logs n'existent probablement pas encore, c'est normal
echo "ğŸ“ Logs response (may be empty): $LOGS_RESPONSE"

echo ""
echo "ğŸ‰ All storage API tests completed successfully!"
echo ""
echo "ğŸ“Š Test Summary:"
echo "  âœ… Health check"
echo "  âœ… Storage info"
echo "  âœ… Multipart file upload (4 files)"
echo "  âœ… File listing"
echo "  âœ… File downloads (all types)"
echo "  âœ… Job creation and status"
echo "  âœ… Error handling"
echo "  âœ… File type validation"
echo ""
echo "ğŸ—‚ï¸ Files uploaded:"
echo "  - slides.md (Markdown content)"
echo "  - theme.css (CSS styling)"
echo "  - config.json (JSON configuration)"
echo "  - logo.svg (SVG image)"
echo ""
echo "ğŸ¯ Next steps:"
echo "  1. Implement Garage S3 storage backend"
echo "  2. Add actual Slidev generation worker"
echo "  3. Test result file generation and download"
echo "  4. Add real-time log streaming"
