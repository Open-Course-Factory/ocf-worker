#!/bin/bash
set -e

# ParamÃ¨tre optionnel pour spÃ©cifier le backend de storage
STORAGE_BACKEND=${1:-"filesystem"}

echo "ğŸ§ª Testing Storage API integration with backend: $STORAGE_BACKEND"

# DÃ©tection automatique de docker compose
DOCKER_COMPOSE_CMD="docker compose"
if ! docker compose version >/dev/null 2>&1; then
    if command -v docker-compose >/dev/null 2>&1; then
        DOCKER_COMPOSE_CMD="docker-compose"
    fi
fi

# VÃ©rifier que les services sont en cours d'exÃ©cution
echo "ğŸ” Checking if services are running..."
if ! $DOCKER_COMPOSE_CMD ps | grep -q "ocf-worker.*Up"; then
    echo "âŒ OCF Worker service is not running!"
    echo "ğŸ’¡ Please start with: make docker-dev"
    exit 1
fi

if ! $DOCKER_COMPOSE_CMD ps | grep -q "postgres-worker.*Up"; then
    echo "âŒ PostgreSQL service is not running!"
    echo "ğŸ’¡ Please start with: make docker-dev"
    exit 1
fi

# VÃ©rification spÃ©cifique pour Garage
if [ "$STORAGE_BACKEND" = "garage" ]; then
    if ! $DOCKER_COMPOSE_CMD --profile garage ps | grep -q "garage.*Up"; then
        echo "âŒ Garage service is not running!"
        echo "ğŸ’¡ Please start with: make garage-start"
        exit 1
    fi
    
    # VÃ©rifier la connectivitÃ© Garage
    if ! curl -s --connect-timeout 5 http://localhost:3900 >/dev/null 2>&1; then
        echo "âŒ Garage S3 API not accessible!"
        echo "ğŸ’¡ Check Garage status with: make garage-status"
        exit 1
    fi
    
    echo "âœ… Garage is running and accessible"
fi

echo "âœ… Services are running"

# Configuration selon le backend
if [ "$STORAGE_BACKEND" = "garage" ]; then
    # Configuration Garage (cohÃ©rente avec le script)
    export STORAGE_TYPE=garage
    export GARAGE_ENDPOINT="http://localhost:3900"
    export GARAGE_ACCESS_KEY="GK31c2f218a2e44f485b94239e"
    export GARAGE_SECRET_KEY="4420d99ef7aa26b56b5130ad7913a6a5c77653a5e7a47a3b4c9b8b9c5f8b7b4d"
    export GARAGE_BUCKET="ocf-test"
    export GARAGE_REGION="garage"
    
    echo "ğŸš€ Using Garage configuration:"
    echo "  Endpoint: $GARAGE_ENDPOINT"
    echo "  Bucket: $GARAGE_BUCKET"
    echo "  Region: $GARAGE_REGION"
    echo "  Access Key: ${GARAGE_ACCESS_KEY:0:10}..."
else
    # Configuration filesystem
    export STORAGE_TYPE=filesystem
    export STORAGE_PATH="./storage"
    
    echo "ğŸ“ Using filesystem configuration:"
    echo "  Storage path: $STORAGE_PATH"
fi

# VÃ©rifier la configuration du storage cÃ´tÃ© serveur
echo "ğŸ”§ Checking server storage configuration..."
STORAGE_INFO=$(curl -s http://localhost:8081/api/v1/storage/info)
echo "$STORAGE_INFO" | jq .

# Attendre que le service soit prÃªt
echo "â³ Waiting for OCF Worker to be ready..."
for i in {1..30}; do
    if curl -s http://localhost:8081/health >/dev/null 2>&1; then
        echo "âœ… OCF Worker is ready"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "âŒ OCF Worker failed to start within 30 seconds"
        echo "ğŸ“Š Service logs:"
        $DOCKER_COMPOSE_CMD logs --tail=20 ocf-worker
        exit 1
    fi
    sleep 1
done

# CrÃ©er les rÃ©pertoires et fichiers de test
mkdir -p test-files

# CrÃ©er des fichiers de test adaptÃ©s au backend
cat > test-files/slides.md << 'MDEOF'
---
theme: default
title: Test Course - OCF Worker Storage
author: OCF Team
description: Generated by OCF Worker with backend storage
highlighter: shiki
lineNumbers: true
colorSchema: auto
---

# Test Course ğŸš€

Welcome to the OCF Worker test course!

**Storage Backend**: STORAGE_BACKEND_PLACEHOLDER

---

## Storage Integration

This course tests the OCF Worker storage capabilities:

- âœ… File upload and storage
- âœ… Multiple storage backends
- âœ… Content type detection
- âœ… API integration

**Current Backend**: STORAGE_BACKEND_PLACEHOLDER

---

## Backend Details

### Filesystem Storage
- Local file storage
- Direct file access
- Fast I/O operations

### Garage Storage  
- S3-compatible API
- Distributed architecture
- Scalable and resilient

---

## API Endpoints

```javascript
// Storage API endpoints
const endpoints = {
  upload: '/api/v1/storage/jobs/{job_id}/sources',
  list: '/api/v1/storage/jobs/{job_id}/sources',
  download: '/api/v1/storage/jobs/{job_id}/sources/{filename}',
  results: '/api/v1/storage/courses/{course_id}/results'
};
```

---

## Thank You! 

Storage backend testing complete âœ…

ğŸŒ **OCF Project**: [ocf-project.org](https://ocf-project.org)  
ğŸ“§ **Email**: support@ocf-project.org
MDEOF

# Remplacer le placeholder par le vrai backend
sed -i "s/STORAGE_BACKEND_PLACEHOLDER/$STORAGE_BACKEND/g" test-files/slides.md

# CrÃ©er d'autres fichiers de test
cat > test-files/theme.css << 'CSSEOF'
/* OCF Worker Storage Test Theme */
:root {
  --ocf-primary: #667eea;
  --ocf-secondary: #764ba2;
  --ocf-accent: #ffd700;
  --storage-bg: linear-gradient(135deg, var(--ocf-primary) 0%, var(--ocf-secondary) 100%);
}

.slidev-layout {
    background: var(--storage-bg);
    color: white;
    font-family: 'Inter', system-ui, sans-serif;
}

.slidev-layout h1 {
    color: var(--ocf-accent);
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    font-weight: 800;
}

.storage-info {
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}
CSSEOF

cat > test-files/config.json << 'JSONEOF'
{
    "theme": "default",
    "title": "OCF Worker Storage Test",
    "author": "OCF Development Team",
    "description": "Integration test for OCF Worker storage backends",
    "highlighter": "shiki",
    "lineNumbers": true,
    "colorSchema": "auto",
    "storage_backend": "STORAGE_BACKEND_PLACEHOLDER",
    "test_timestamp": "TIMESTAMP_PLACEHOLDER"
}
JSONEOF

# Remplacer les placeholders
sed -i "s/STORAGE_BACKEND_PLACEHOLDER/$STORAGE_BACKEND/g" test-files/config.json
sed -i "s/TIMESTAMP_PLACEHOLDER/$(date -u +%Y-%m-%dT%H:%M:%SZ)/g" test-files/config.json

# Fonction pour nettoyer
cleanup() {
    echo "ğŸ§¹ Cleaning up test files..."
    rm -rf test-files
}

trap cleanup EXIT

# Test health check
echo "ğŸ“Š Testing health check..."
HEALTH_RESPONSE=$(curl -s http://localhost:8081/health)
echo "$HEALTH_RESPONSE" | jq .
if echo "$HEALTH_RESPONSE" | jq -e '.status == "healthy"' >/dev/null; then
    echo "âœ… Health check passed"
else
    echo "âŒ Health check failed"
    exit 1
fi

# GÃ©nÃ©rer des IDs pour les tests
if command -v uuidgen >/dev/null 2>&1; then
    JOB_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
    COURSE_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
else
    JOB_ID="test-job-$(date +%s)"
    COURSE_ID="test-course-$(date +%s)"
fi

echo "ğŸ†” Using Job ID: $JOB_ID"
echo "ğŸ†” Using Course ID: $COURSE_ID"

# Test upload de fichiers sources
echo "ğŸ“¤ Testing multipart file upload..."
UPLOAD_RESPONSE=$(curl -s -X POST \
  -F "files=@test-files/slides.md" \
  -F "files=@test-files/theme.css" \
  -F "files=@test-files/config.json" \
  http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources)

echo "$UPLOAD_RESPONSE" | jq .

if echo "$UPLOAD_RESPONSE" | jq -e '.count == 3' >/dev/null; then
    echo "âœ… File upload successful (3 files)"
else
    echo "âŒ File upload failed"
    echo "Expected 3 files, got: $(echo "$UPLOAD_RESPONSE" | jq '.count // "unknown"')"
    exit 1
fi

# Test listing des fichiers sources
echo "ğŸ“ Testing source files listing..."
LIST_RESPONSE=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources)
echo "$LIST_RESPONSE" | jq .

FILE_COUNT=$(echo "$LIST_RESPONSE" | jq '.files | length')
if [ "$FILE_COUNT" -eq 3 ]; then
    echo "âœ… File listing successful ($FILE_COUNT files found)"
else
    echo "âŒ File listing failed (expected 3 files, got $FILE_COUNT)"
    exit 1
fi

# Test download de fichiers avec validation du contenu
echo "ğŸ“¥ Testing file downloads..."

# Test slides.md
echo "ğŸ“„ Downloading slides.md..."
SLIDES_CONTENT=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/slides.md)
if echo "$SLIDES_CONTENT" | grep -q "Storage Backend.*$STORAGE_BACKEND"; then
    echo "âœ… slides.md download successful and contains correct backend info"
else
    echo "âŒ slides.md download failed or doesn't contain backend info"
    exit 1
fi

# Test config.json
echo "âš™ï¸ Downloading config.json..."
CONFIG_CONTENT=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/config.json)
if echo "$CONFIG_CONTENT" | jq -e ".storage_backend == \"$STORAGE_BACKEND\"" >/dev/null 2>&1; then
    echo "âœ… config.json download successful and backend matches"
else
    echo "âŒ config.json download failed or backend mismatch"
    exit 1
fi

# Test crÃ©ation d'un job
echo "ğŸ“‹ Testing job creation..."
JOB_RESPONSE=$(curl -s -X POST http://localhost:8081/api/v1/generate \
  -H "Content-Type: application/json" \
  -d "{
    \"job_id\": \"$JOB_ID\",
    \"course_id\": \"$COURSE_ID\",
    \"source_path\": \"sources/$JOB_ID/\",
    \"callback_url\": \"http://localhost:8080/api/v1/generations/$JOB_ID/status\",
    \"metadata\": {
      \"storage_backend\": \"$STORAGE_BACKEND\",
      \"test_run\": true,
      \"test_timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
    }
  }")

echo "$JOB_RESPONSE" | jq .

if echo "$JOB_RESPONSE" | jq -e '.status == "pending"' >/dev/null; then
    echo "âœ… Job creation successful"
else
    echo "âŒ Job creation failed"
    exit 1
fi

# Test rÃ©cupÃ©ration du statut
echo "ğŸ“ˆ Testing job status retrieval..."
STATUS_RESPONSE=$(curl -s http://localhost:8081/api/v1/jobs/$JOB_ID)
echo "$STATUS_RESPONSE" | jq .

if echo "$STATUS_RESPONSE" | jq -e '.id' >/dev/null; then
    echo "âœ… Job status retrieval successful"
    
    # VÃ©rifier les mÃ©tadonnÃ©es
    if echo "$STATUS_RESPONSE" | jq -e ".metadata.storage_backend == \"$STORAGE_BACKEND\"" >/dev/null; then
        echo "âœ… Metadata preserved correctly"
    else
        echo "âš ï¸ Metadata may not be preserved correctly"
    fi
else
    echo "âŒ Job status retrieval failed"
    exit 1
fi

# Tests spÃ©cifiques au backend
echo "ğŸ”§ Testing backend-specific features..."

case $STORAGE_BACKEND in
    "filesystem")
        echo "ğŸ“ Testing filesystem storage..."
        # VÃ©rifier dans le container
        if $DOCKER_COMPOSE_CMD exec ocf-worker ls -la /app/storage/sources/$JOB_ID/ 2>/dev/null; then
            echo "âœ… Filesystem storage verification successful"
        else
            echo "âš ï¸ Could not verify filesystem storage (may be using different path)"
        fi
        ;;
    "garage")
        echo "ğŸš€ Testing Garage S3 storage..."
        # Test spÃ©cifique Garage
        echo "ğŸ” Testing Garage bucket access..."
        
        # VÃ©rifier que le bucket existe via l'API admin
        if $DOCKER_COMPOSE_CMD exec -T garage /garage bucket list 2>/dev/null | grep -q "ocf-test"; then
            echo "âœ… Garage bucket 'ocf-test' exists"
        else
            echo "âš ï¸ Cannot verify Garage bucket existence"
        fi
        
        # Test de connectivitÃ© S3
        echo "ğŸŒ Testing S3 API connectivity..."
        if curl -s --connect-timeout 5 "$GARAGE_ENDPOINT" >/dev/null 2>&1; then
            echo "âœ… Garage S3 API is accessible"
        else
            echo "âŒ Garage S3 API is not accessible"
        fi
        ;;
    *)
        echo "âš ï¸ Unknown storage backend: $STORAGE_BACKEND"
        ;;
esac

# Test de performance basique
echo "âš¡ Testing basic performance..."
START_TIME=$(date +%s%N)

# Test d'un fichier plus grand
echo "Creating performance test file..."
dd if=/dev/zero of=test-files/perf-test.md bs=1024 count=10 2>/dev/null
echo "# Performance Test File" >> test-files/perf-test.md
echo "This is a test file for performance testing." >> test-files/perf-test.md

PERF_UPLOAD_RESPONSE=$(curl -s -X POST \
  -F "files=@test-files/perf-test.md" \
  http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources)

END_TIME=$(date +%s%N)
DURATION=$(( (END_TIME - START_TIME) / 1000000 ))

if echo "$PERF_UPLOAD_RESPONSE" | jq -e '.count == 1' >/dev/null 2>&1; then
    echo "âœ… Performance test completed in ${DURATION}ms"
else
    echo "â„¹ï¸ Performance test completed"
fi

rm -f test-files/perf-test.md

echo ""
echo "ğŸ‰ All storage API tests completed successfully!"
echo ""
echo "ğŸ“Š Test Summary for backend: $STORAGE_BACKEND"
echo "  âœ… Health check"
echo "  âœ… Storage configuration"
echo "  âœ… File upload (3 files)"
echo "  âœ… File listing"
echo "  âœ… File downloads with content validation"
echo "  âœ… Job creation with metadata"
echo "  âœ… Job status retrieval"
echo "  âœ… Backend-specific features"
echo "  âœ… Performance testing"

case $STORAGE_BACKEND in
    "filesystem")
        echo ""
        echo "ğŸ“ Filesystem Storage Features:"
        echo "  - Local file system storage"
        echo "  - Direct file access in container"
        echo "  - Fast local I/O operations"
        ;;
    "garage")
        echo ""
        echo "ğŸš€ Garage Storage Features:"
        echo "  - S3-compatible API"
        echo "  - Distributed storage"
        echo "  - Endpoint: $GARAGE_ENDPOINT"
        echo "  - Bucket: $GARAGE_BUCKET"
        echo "  - Region: $GARAGE_REGION"
        ;;
esac

echo ""
echo "ğŸ¯ Files tested:"
echo "  - slides.md (with backend-specific content)"
echo "  - theme.css (CSS styling)"
echo "  - config.json (with backend metadata)"
echo ""
echo "ğŸ—‚ï¸ Test metadata:"
echo "  ğŸ“¦ Job ID: $JOB_ID"
echo "  ğŸ“ Course ID: $COURSE_ID"
echo "  ğŸ—„ï¸ Storage Backend: $STORAGE_BACKEND"
echo "  ğŸ“Š Files Processed: 3"
echo "  â±ï¸ Performance Test: ${DURATION}ms"

echo ""
echo "âœ¨ OCF Worker Storage API testing complete! âœ¨"