#!/bin/bash
set -e

# ParamÃ¨tre optionnel pour spÃ©cifier le backend de storage
STORAGE_BACKEND=${1:-"filesystem"}

echo "ğŸ§ª Testing Storage API integration with backend: $STORAGE_BACKEND"

# VÃ©rifier que les services sont en cours d'exÃ©cution
echo "ğŸ” Checking if services are running..."
if ! docker-compose ps | grep -q "ocf-worker.*Up"; then
    echo "âŒ OCF Worker service is not running!"
    echo "ğŸ’¡ Please start with: docker-compose up -d"
    exit 1
fi

if ! docker-compose ps | grep -q "postgres-worker.*Up"; then
    echo "âŒ PostgreSQL service is not running!"
    echo "ğŸ’¡ Please start with: docker-compose up -d"
    exit 1
fi

echo "âœ… Services are running"

# VÃ©rifier la configuration du storage
echo "ğŸ”§ Checking storage configuration..."
STORAGE_INFO=$(curl -s http://localhost:8081/api/v1/storage/info)
echo "$STORAGE_INFO" | jq .

# Attendre que le service soit prÃªt
echo "â³ Waiting for OCF Worker to be ready..."
for i in {1..30}; do
    if curl -s http://localhost:8081/health >/dev/null 2>&1; then
        echo "âœ… OCF Worker is ready"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "âŒ OCF Worker failed to start within 30 seconds"
        echo "ğŸ“Š Service logs:"
        docker-compose logs --tail=20 ocf-worker
        exit 1
    fi
    sleep 1
done

# CrÃ©er les rÃ©pertoires et fichiers de test
mkdir -p test-files

# CrÃ©er des fichiers de test plus variÃ©s pour tester les diffÃ©rents content-types
cat > test-files/slides.md << 'MDEOF'
---
theme: default
title: Test Course - OCF Worker
author: OCF Team
description: Generated by OCF Worker with backend storage
highlighter: prism
lineNumbers: true
colorSchema: auto
---

# Test Course ğŸš€

Welcome to the OCF Worker test course!

---

## Introduction

This course tests the OCF Worker storage capabilities:

- âœ… File upload and storage
- âœ… Multiple storage backends
- âœ… Content type detection
- âœ… API integration

---

## Storage Backend

Currently testing: **STORAGE_BACKEND**

- **Filesystem**: Local file storage
- **Garage**: S3-compatible distributed storage

---

## Code Example

```javascript
// OCF Worker API Example
const response = await fetch('/api/v1/generate', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    job_id: uuid(),
    course_id: uuid(),
    source_path: 'courses/my-course/',
    callback_url: 'https://my-app.com/webhook'
  })
});

const job = await response.json();
console.log('Job created:', job.id);
```

---

## Features

<div class="grid grid-cols-2 gap-4">

<div>

### âš¡ Fast Generation
- Async processing
- Real-time status
- Progress tracking

</div>

<div>

### ğŸ”’ Reliable Storage
- Multiple backends
- Error handling
- Cleanup automation

</div>

</div>

---

## Thank You! 

Questions? Check our documentation!

ğŸŒ **Website**: [ocf-project.org](https://ocf-project.org)  
ğŸ“§ **Email**: support@ocf-project.org  
ğŸ’¬ **Discord**: [Join our community](https://discord.gg/ocf)
MDEOF

# Remplacer le placeholder par le vrai backend
sed -i "s/STORAGE_BACKEND/$STORAGE_BACKEND/g" test-files/slides.md

cat > test-files/theme.css << 'CSSEOF'
/* OCF Worker Test Theme */
:root {
  --ocf-primary: #667eea;
  --ocf-secondary: #764ba2;
  --ocf-accent: #ffd700;
  --ocf-bg: #1a1a2e;
  --ocf-text: #ffffff;
}

.slidev-layout {
    background: linear-gradient(135deg, var(--ocf-primary) 0%, var(--ocf-secondary) 100%);
    color: var(--ocf-text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.slidev-layout h1 {
    color: var(--ocf-accent);
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    font-weight: 800;
    font-size: 3rem;
}

.slidev-layout h2 {
    border-bottom: 3px solid var(--ocf-accent);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.slidev-layout h3 {
    color: var(--ocf-accent);
    font-weight: 500;
}

.slidev-layout code {
    background: rgba(0,0,0,0.3);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
}

.slidev-layout pre {
    background: rgba(0,0,0,0.4) !important;
    border: 1px solid rgba(255,215,0,0.2);
    border-radius: 0.5rem;
    padding: 1rem;
}

.slidev-layout .grid {
    display: grid;
    gap: 1rem;
}

.slidev-layout .grid-cols-2 {
    grid-template-columns: repeat(2, 1fr);
}

.slidev-layout .gap-4 {
    gap: 1rem;
}

.slidev-layout ul li {
    margin: 0.5rem 0;
    position: relative;
}

.slidev-layout ul li::before {
    content: "â†’";
    color: var(--ocf-accent);
    font-weight: bold;
    position: absolute;
    left: -1.5rem;
}

/* Animation pour les transitions */
.slidev-vclick-target {
    transition: all 0.3s ease;
}

.slidev-vclick-hidden {
    transform: translateY(20px);
    opacity: 0;
}

/* Style pour les liens */
.slidev-layout a {
    color: var(--ocf-accent);
    text-decoration: none;
    border-bottom: 1px dotted var(--ocf-accent);
    transition: all 0.2s ease;
}

.slidev-layout a:hover {
    border-bottom-style: solid;
    background: rgba(255,215,0,0.1);
    padding: 0.1rem 0.2rem;
    border-radius: 0.2rem;
}
CSSEOF

cat > test-files/config.json << 'JSONEOF'
{
    "theme": "default",
    "title": "OCF Worker Test Course",
    "author": "OCF Development Team",
    "description": "Integration test for OCF Worker storage backends",
    "highlighter": "prism",
    "lineNumbers": true,
    "monaco": true,
    "colorSchema": "auto",
    "background": "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
    "favicon": "./logo.svg",
    "fonts": {
        "sans": ["Inter", "system-ui"],
        "mono": ["JetBrains Mono", "Fira Code"]
    },
    "themeConfig": {
        "primary": "#667eea",
        "secondary": "#764ba2"
    },
    "exportFilename": "ocf-worker-test-course",
    "export": {
        "format": "pdf",
        "timeout": 30000,
        "dark": false,
        "withClicks": true
    },
    "drawings": {
        "enabled": true,
        "persist": false
    },
    "plantUml": {
        "server": "https://www.plantuml.com/plantuml"
    }
}
JSONEOF

cat > test-files/logo.svg << 'SVGEOF'
<svg width="120" height="120" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120">
  <defs>
    <linearGradient id="ocfGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
    </linearGradient>
  </defs>
  
  <!-- Background circle -->
  <circle cx="60" cy="60" r="55" fill="url(#ocfGradient)" stroke="#ffd700" stroke-width="3"/>
  
  <!-- OCF Text -->
  <text x="60" y="70" text-anchor="middle" fill="#ffffff" font-size="28" font-weight="bold" font-family="Arial, sans-serif">OCF</text>
  
  <!-- Subtitle -->
  <text x="60" y="85" text-anchor="middle" fill="#ffd700" font-size="10" font-family="Arial, sans-serif">WORKER</text>
  
  <!-- Decorative elements -->
  <circle cx="30" cy="30" r="3" fill="#ffd700" opacity="0.8"/>
  <circle cx="90" cy="30" r="2" fill="#ffd700" opacity="0.6"/>
  <circle cx="30" cy="90" r="2" fill="#ffd700" opacity="0.6"/>
  <circle cx="90" cy="90" r="3" fill="#ffd700" opacity="0.8"/>
</svg>
SVGEOF

# CrÃ©er un fichier JavaScript pour tester les content-types
cat > test-files/custom.js << 'JSEOF'
// OCF Worker Custom JavaScript
console.log('OCF Worker Test - Custom JS loaded');

// Fonction utilitaire pour les prÃ©sentations
window.ocfUtils = {
    // Animation d'entrÃ©e pour les Ã©lÃ©ments
    animateIn: (selector, delay = 0) => {
        setTimeout(() => {
            const elements = document.querySelectorAll(selector);
            elements.forEach((el, index) => {
                el.style.transform = 'translateY(0)';
                el.style.opacity = '1';
            });
        }, delay);
    },
    
    // Logger pour debug
    log: (message) => {
        console.log(`[OCF Worker] ${message}`);
    },
    
    // DÃ©tection du backend de storage
    getStorageBackend: () => {
        return window.location.search.includes('garage') ? 'garage' : 'filesystem';
    }
};

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
    window.ocfUtils.log('OCF Worker test presentation initialized');
    window.ocfUtils.log(`Storage backend: ${window.ocfUtils.getStorageBackend()}`);
    
    // Animer les Ã©lÃ©ments avec un dÃ©lai
    window.ocfUtils.animateIn('.slidev-vclick-target', 300);
});

// Export pour utilisation dans les slides
if (typeof module !== 'undefined' && module.exports) {
    module.exports = window.ocfUtils;
}
JSEOF

# Fonction pour nettoyer
cleanup() {
    echo "ğŸ§¹ Cleaning up test files..."
    rm -rf test-files
}

trap cleanup EXIT

# Test health check avec information du backend
echo "ğŸ“Š Testing health check..."
HEALTH_RESPONSE=$(curl -s http://localhost:8081/health)
echo "$HEALTH_RESPONSE" | jq .
if echo "$HEALTH_RESPONSE" | jq -e '.status == "healthy"' >/dev/null; then
    echo "âœ… Health check passed"
else
    echo "âŒ Health check failed"
    exit 1
fi

# Test storage info avec vÃ©rification du backend
echo "ğŸ“‹ Testing storage info..."
STORAGE_INFO=$(curl -s http://localhost:8081/api/v1/storage/info)
echo "$STORAGE_INFO" | jq .
echo "âœ… Storage info retrieved"

# GÃ©nÃ©rer des IDs pour les tests
if command -v uuidgen >/dev/null 2>&1; then
    JOB_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
    COURSE_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
else
    # Fallback si uuidgen n'est pas disponible
    JOB_ID="test-job-$(date +%s)"
    COURSE_ID="test-course-$(date +%s)"
fi

echo "ğŸ†” Using Job ID: $JOB_ID"
echo "ğŸ†” Using Course ID: $COURSE_ID"

# Test upload de fichiers sources avec plus de types
echo "ğŸ“¤ Testing multipart file upload with various content types..."
UPLOAD_RESPONSE=$(curl -s -X POST \
  -F "files=@test-files/slides.md" \
  -F "files=@test-files/theme.css" \
  -F "files=@test-files/config.json" \
  -F "files=@test-files/logo.svg" \
  -F "files=@test-files/custom.js" \
  http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources)

echo "$UPLOAD_RESPONSE" | jq .

if echo "$UPLOAD_RESPONSE" | jq -e '.count == 5' >/dev/null; then
    echo "âœ… File upload successful (5 files)"
else
    echo "âŒ File upload failed"
    echo "Expected 5 files, got: $(echo "$UPLOAD_RESPONSE" | jq '.count // "unknown"')"
    exit 1
fi

# Test listing des fichiers sources
echo "ğŸ“ Testing source files listing..."
LIST_RESPONSE=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources)
echo "$LIST_RESPONSE" | jq .

FILE_COUNT=$(echo "$LIST_RESPONSE" | jq '.files | length')
if [ "$FILE_COUNT" -eq 5 ]; then
    echo "âœ… File listing successful ($FILE_COUNT files found)"
else
    echo "âŒ File listing failed (expected 5 files, got $FILE_COUNT)"
    exit 1
fi

# Test download de chaque fichier source avec vÃ©rification du content-type
echo "ğŸ“¥ Testing source file downloads with content-type validation..."

# Test download slides.md
echo "ğŸ“„ Downloading slides.md:"
SLIDES_RESPONSE=$(curl -s -I http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/slides.md)
if echo "$SLIDES_RESPONSE" | grep -q "Content-Type: text/markdown"; then
    echo "âœ… slides.md content-type correct"
else
    echo "âš ï¸  slides.md content-type may be different"
fi

SLIDES_CONTENT=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/slides.md)
if echo "$SLIDES_CONTENT" | grep -q "OCF Worker test course"; then
    echo "âœ… slides.md download successful"
else
    echo "âŒ slides.md download failed"
    exit 1
fi

# Test download theme.css
echo "ğŸ¨ Downloading theme.css:"
CSS_RESPONSE=$(curl -s -I http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/theme.css)
if echo "$CSS_RESPONSE" | grep -q "Content-Type: text/css"; then
    echo "âœ… theme.css content-type correct"
fi

THEME_CONTENT=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/theme.css)
if echo "$THEME_CONTENT" | grep -q "ocf-primary"; then
    echo "âœ… theme.css download successful"
else
    echo "âŒ theme.css download failed"
    exit 1
fi

# Test download config.json
echo "âš™ï¸ Downloading config.json:"
JSON_RESPONSE=$(curl -s -I http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/config.json)
if echo "$JSON_RESPONSE" | grep -q "Content-Type: application/json"; then
    echo "âœ… config.json content-type correct"
fi

CONFIG_CONTENT=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/config.json)
if echo "$CONFIG_CONTENT" | jq -e '.title == "OCF Worker Test Course"' >/dev/null 2>&1; then
    echo "âœ… config.json download successful"
else
    echo "âŒ config.json download failed"
    exit 1
fi

# Test download logo.svg
echo "ğŸ–¼ï¸ Downloading logo.svg:"
SVG_RESPONSE=$(curl -s -I http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/logo.svg)
if echo "$SVG_RESPONSE" | grep -q "Content-Type: image/svg+xml"; then
    echo "âœ… logo.svg content-type correct"
fi

LOGO_CONTENT=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/logo.svg)
if echo "$LOGO_CONTENT" | grep -q "OCF"; then
    echo "âœ… logo.svg download successful"
else
    echo "âŒ logo.svg download failed"
    exit 1
fi

# Test download custom.js
echo "âš¡ Downloading custom.js:"
JS_RESPONSE=$(curl -s -I http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/custom.js)
if echo "$JS_RESPONSE" | grep -q "Content-Type: application/javascript"; then
    echo "âœ… custom.js content-type correct"
fi

JS_CONTENT=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/custom.js)
if echo "$JS_CONTENT" | grep -q "ocfUtils"; then
    echo "âœ… custom.js download successful"
else
    echo "âŒ custom.js download failed"
    exit 1
fi

# Test crÃ©ation d'un job via API
echo "ğŸ“‹ Testing job creation..."
JOB_RESPONSE=$(curl -s -X POST http://localhost:8081/api/v1/generate \
  -H "Content-Type: application/json" \
  -d "{
    \"job_id\": \"$JOB_ID\",
    \"course_id\": \"$COURSE_ID\",
    \"source_path\": \"sources/$JOB_ID/\",
    \"callback_url\": \"http://localhost:8080/api/v1/generations/$JOB_ID/status\",
    \"metadata\": {
      \"storage_backend\": \"$STORAGE_BACKEND\",
      \"test_run\": true,
      \"course_name\": \"OCF Worker Test Course\"
    }
  }")

echo "$JOB_RESPONSE" | jq .

if echo "$JOB_RESPONSE" | jq -e '.status == "pending"' >/dev/null; then
    echo "âœ… Job creation successful"
else
    echo "âŒ Job creation failed"
    exit 1
fi

# Test rÃ©cupÃ©ration du statut du job
echo "ğŸ“ˆ Testing job status retrieval..."
STATUS_RESPONSE=$(curl -s http://localhost:8081/api/v1/jobs/$JOB_ID)
echo "$STATUS_RESPONSE" | jq .

if echo "$STATUS_RESPONSE" | jq -e '.id' >/dev/null; then
    echo "âœ… Job status retrieval successful"
    
    # VÃ©rifier que les mÃ©tadonnÃ©es sont bien sauvegardÃ©es
    if echo "$STATUS_RESPONSE" | jq -e '.metadata.storage_backend' >/dev/null; then
        STORED_BACKEND=$(echo "$STATUS_RESPONSE" | jq -r '.metadata.storage_backend')
        echo "âœ… Metadata preserved - Storage backend: $STORED_BACKEND"
    fi
else
    echo "âŒ Job status retrieval failed"
    exit 1
fi

# Test listing de tous les jobs avec filtrage
echo "ğŸ“Š Testing jobs listing with filters..."
ALL_JOBS_RESPONSE=$(curl -s http://localhost:8081/api/v1/jobs)
JOBS_COUNT=$(echo "$ALL_JOBS_RESPONSE" | jq '.jobs | length')
echo "ğŸ“ Total jobs: $JOBS_COUNT"

PENDING_JOBS_RESPONSE=$(curl -s "http://localhost:8081/api/v1/jobs?status=pending")
PENDING_COUNT=$(echo "$PENDING_JOBS_RESPONSE" | jq '.jobs | length')
echo "â³ Pending jobs: $PENDING_COUNT"

COURSE_JOBS_RESPONSE=$(curl -s "http://localhost:8081/api/v1/jobs?course_id=$COURSE_ID")
COURSE_COUNT=$(echo "$COURSE_JOBS_RESPONSE" | jq '.jobs | length')
echo "ğŸ“ Jobs for course $COURSE_ID: $COURSE_COUNT"

echo "âœ… Jobs listing and filtering successful"

# Test des erreurs - fichier inexistant
echo "ğŸš« Testing error handling..."
ERROR_RESPONSE=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources/nonexistent.txt)
if echo "$ERROR_RESPONSE" | grep -q "error"; then
    echo "âœ… Error handling working correctly"
else
    echo "âŒ Error handling failed"
fi

# Test upload avec type de fichier non autorisÃ©
echo "ğŸš« Testing file type validation..."
echo "malicious content" > test-files/malicious.exe
UPLOAD_ERROR=$(curl -s -X POST \
  -F "files=@test-files/malicious.exe" \
  http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources)

if echo "$UPLOAD_ERROR" | grep -q "file type not allowed"; then
    echo "âœ… File type validation working"
else
    echo "âŒ File type validation failed"
    echo "Response: $UPLOAD_ERROR"
fi

rm -f test-files/malicious.exe

# Test spÃ©cifique au backend storage
echo "ğŸ”§ Testing storage backend specific features..."

case $STORAGE_BACKEND in
    "filesystem")
        echo "ğŸ“ Testing filesystem storage..."
        # VÃ©rifier dans le container
        echo "ğŸ³ Checking files in Docker container..."
        if docker-compose exec ocf-worker ls -la /app/storage/sources/$JOB_ID/ 2>/dev/null; then
            echo "âœ… Filesystem storage verification successful"
        else
            echo "âš ï¸  Could not verify filesystem storage (container may be configured differently)"
        fi
        ;;
    "garage")
        echo "ğŸš€ Testing Garage S3 storage..."
        # Test des URLs prÃ©signÃ©es (spÃ©cifique Ã  S3/Garage)
        echo "ğŸ”— Testing presigned URLs (Garage feature)..."
        
        # Pour Garage, nous pouvons potentiellement accÃ©der directement Ã  l'API
        if [ -n "$GARAGE_ENDPOINT" ] && [ -n "$GARAGE_ACCESS_KEY" ]; then
            echo "âœ… Garage storage configuration detected"
            echo "ğŸ“¡ Endpoint: $GARAGE_ENDPOINT"
            echo "ğŸª£ Bucket: ${GARAGE_BUCKET:-ocf-courses}"
        else
            echo "â„¹ï¸  Garage configuration not available in environment"
        fi
        ;;
    *)
        echo "âš ï¸  Unknown storage backend: $STORAGE_BACKEND"
        ;;
esac

# Test performance basique
echo "âš¡ Testing basic performance..."
START_TIME=$(date +%s%N)

# Upload d'un fichier plus gros pour tester les performances
echo "Creating larger test file..."
dd if=/dev/zero of=test-files/large-file.bin bs=1024 count=100 2>/dev/null
LARGE_UPLOAD_RESPONSE=$(curl -s -X POST \
  -F "files=@test-files/large-file.bin" \
  http://localhost:8081/api/v1/storage/jobs/$JOB_ID/sources)

END_TIME=$(date +%s%N)
DURATION=$(( (END_TIME - START_TIME) / 1000000 )) # Convert to milliseconds

if echo "$LARGE_UPLOAD_RESPONSE" | grep -q "file type not allowed"; then
    echo "âœ… Large file rejected (expected - .bin not in allowed types)"
elif echo "$LARGE_UPLOAD_RESPONSE" | jq -e '.count == 1' >/dev/null 2>&1; then
    echo "âœ… Large file upload successful in ${DURATION}ms"
else
    echo "â„¹ï¸  Large file test completed"
fi

rm -f test-files/large-file.bin

# Test des logs (mÃªme s'ils sont vides pour l'instant)
echo "ğŸ“ Testing logs retrieval..."
LOGS_RESPONSE=$(curl -s http://localhost:8081/api/v1/storage/jobs/$JOB_ID/logs)
if [ "$?" -eq 0 ]; then
    echo "âœ… Logs endpoint accessible (content may be empty - normal for now)"
else
    echo "âš ï¸  Logs endpoint returned error (may be expected if no logs exist)"
fi

# Test de nettoyage conditionnel
echo "ğŸ§¹ Testing cleanup capabilities..."
NEW_JOB_ID=$(uuidgen | tr '[:upper:]' '[:lower:]' 2>/dev/null || echo "cleanup-test-$(date +%s)")

# Upload d'un fichier pour le cleanup test
echo "test cleanup" > test-files/cleanup-test.txt
CLEANUP_UPLOAD=$(curl -s -X POST \
  -F "files=@test-files/cleanup-test.txt" \
  http://localhost:8081/api/v1/storage/jobs/$NEW_JOB_ID/sources)

if echo "$CLEANUP_UPLOAD" | jq -e '.count == 1' >/dev/null; then
    echo "âœ… Cleanup test file uploaded"
    
    # VÃ©rifier qu'il existe
    CLEANUP_LIST=$(curl -s http://localhost:8081/api/v1/storage/jobs/$NEW_JOB_ID/sources)
    if echo "$CLEANUP_LIST" | jq -e '.files | length == 1' >/dev/null; then
        echo "âœ… Cleanup test file confirmed in storage"
    fi
else
    echo "âš ï¸  Cleanup test file upload failed"
fi

rm -f test-files/cleanup-test.txt

# RÃ©sumÃ© des tests selon le backend
echo ""
echo "ğŸ‰ All storage API tests completed successfully!"
echo ""
echo "ğŸ“Š Test Summary for backend: $STORAGE_BACKEND"
echo "  âœ… Health check"
echo "  âœ… Storage info"
echo "  âœ… Multipart file upload (5 files)"
echo "  âœ… Content-type validation"
echo "  âœ… File listing and filtering"
echo "  âœ… File downloads (all types)"
echo "  âœ… Job creation with metadata"
echo "  âœ… Job status and filtering"
echo "  âœ… Error handling"
echo "  âœ… File type validation"
echo "  âœ… Performance testing"

case $STORAGE_BACKEND in
    "filesystem")
        echo "  âœ… Filesystem storage verification"
        echo ""
        echo "ğŸ“ Filesystem Storage Features:"
        echo "  - Local file system storage"
        echo "  - Direct file access in container"
        echo "  - Fast local I/O operations"
        ;;
    "garage")
        echo "  âœ… Garage S3 storage integration"
        echo ""
        echo "ğŸš€ Garage Storage Features:"
        echo "  - S3-compatible API"
        echo "  - Distributed storage"
        echo "  - Presigned URLs support"
        echo "  - Geographic replication ready"
        ;;
esac

echo ""
echo "ğŸ—‚ï¸ Files tested:"
echo "  - slides.md (Markdown presentation)"
echo "  - theme.css (CSS styling with OCF branding)"
echo "  - config.json (Slidev configuration)"
echo "  - logo.svg (SVG logo with gradients)"
echo "  - custom.js (JavaScript utilities)"
echo ""
echo "ğŸ¯ Next steps:"
if [ "$STORAGE_BACKEND" = "filesystem" ]; then
    echo "  1. âœ… Filesystem storage working"
    echo "  2. ğŸš€ Test Garage storage: STORAGE_TYPE=garage docker-compose up"
    echo "  3. ğŸ”„ Implement Slidev generation worker"
    echo "  4. ğŸ“Š Add result file generation and download"
else
    echo "  1. âœ… Garage storage working"
    echo "  2. ğŸ”„ Implement Slidev generation worker"
    echo "  3. ğŸ“Š Add result file generation and download"
    echo "  4. ğŸŒ Configure production Garage cluster"
fi
echo "  5. ğŸ“¡ Add real-time log streaming"
echo "  6. ğŸ”” Implement webhook notifications"

# Information de debug
echo ""
echo "ğŸ”§ Debug Information:"
echo "  ğŸ“¦ Job ID: $JOB_ID"
echo "  ğŸ“ Course ID: $COURSE_ID"
echo "  ğŸ—„ï¸ Storage Backend: $STORAGE_BACKEND"
echo "  ğŸ“Š Total Files Uploaded: 5"
echo "  â±ï¸  Test Duration: ~30-60 seconds"

if [ "$STORAGE_BACKEND" = "garage" ]; then
    echo ""
    echo "ğŸš€ Garage Configuration:"
    echo "  ğŸ“¡ Endpoint: ${GARAGE_ENDPOINT:-'Not set'}"
    echo "  ğŸª£ Bucket: ${GARAGE_BUCKET:-'ocf-courses'}"
    echo "  ğŸŒ Region: ${GARAGE_REGION:-'us-east-1'}"
    echo ""
    echo "ğŸ’¡ To test Garage storage:"
    echo "   1. Run: ./scripts/test-garage.sh"
    echo "   2. Update .env with Garage configuration"
    echo "   3. Restart: docker-compose down && docker-compose up -d"
    echo "   4. Test: ./test_storage_api.sh garage"
fi

echo ""
echo "âœ¨ OCF Worker Storage API testing complete! âœ¨"